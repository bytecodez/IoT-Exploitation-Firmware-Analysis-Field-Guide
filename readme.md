
### first of: where to get firmware?

- dd-wrt firmware db:
	- https://dd-wrt.com/support/router-database/
- manufacturer support website or FTP site
	- https://www.tp-link.com/us/support/download/
	- ^ example, most have there firmware under support
- dump from device memory  (connect via hardware)
	- https://ianhowson.com/iot/extracting-firmware/
---

### what the fuck is a bootloader?
- bootloaders run before the OS & usually has a few ways to boot the OS kernel & also contains commands for debugging / modifying the kernel environment.

#### common bootloaders:
- U-BOOT
- RedBoot
- BareBox
- BusyBox
- many many more...

- but why're we recapping on bootloaders this is pretty trivial right? WRONG! This is an important attack vector because if we can control the bootloader we can control the firmware that's going to be installed.
	- bootloader attacks!

---

### attacking the firmware for fun & profit

- ##### static analysis:
	 - analyze filesystem
		- run firmwalker on the filesystem & try to find goodies

	- inspect bootloader & kernel
		- are they outdated with known vulnerabilities?
		- vulnerable to bootloader attacks?

	  - look for "hard-coded" items
		- keys, credentials, hashes & network values
	
	 - use your tools!
		- binwalk, firmadyne, firmwalker, etc
		
	 - misc:
		- updates not verfied before upload/install
		- updates not encrypted 
		- encryption not used for sensitive information

- ##### dynamic analysis:
	- Virtualize the IoT device with qemu or docker or both!
	- fuzzing?
		- fuzzing what? well i guess you'll have to learn what and where takes input and decide whether its worth fuzzing those points!
	- TCPdump or wireshark
	- Nmap (look for services running and what not)

---
### firmware reversing
- analyze binaries gathered via IDA or ghidra or whatever, view the dissasembly.

- look for binaries present within the firmware or even filesystem, check to see if they're outdated and have any vulnerabilties in them.

- use dd for copying certain files found while using binwalk. useful for extracting certain blocks.
	- example:
```bash
#  in file  #  decimal location  # block size # out file
dd if=firmware.bin skip=327744 bs=1 of=kernel.lzma
```

- ## dealing with encryption:
	- ### defeating encryption:
		- https://onekey.com/blog/extracting-decryption-keys-dlink/
			- good source & real-world example on reversing encryption methods by d-link

		   - The simplest method to decrypt the firmware is to look for the decryption routine within the firmware.
			- If the IoT device can decrypt the new firmware for updates, the decryption routine must be located in the old firmware image somewhere. If you encounter an encrypted firmware, go to the vendor website and look for archived versions of the firmware, download all old versions and start poking around.

		  - ### 3 scenerios you may run into:
			  - #1 ![alt text](https://images.squarespace-cdn.com/content/v1/5894c269e4fcb5e65a1ed623/1581004558438-UJV08PX8O5NVAQ6Z8HXI/Picture2.png?format=1000w)
			  - scenerio one: The device firmware was not encrypted nor did it contain any decryption routine when it was factory released. A decryption routine is shipped along with an unencrypted version of the firmware in a newer version (v1.1) for future encrypted firmware update. Subsequent firmware releases are encrypted.
				  - In this scenario, we can obtain the decryption routine from firmware v1.1 and use it to decrypt the latest firmware version 1.2.

			- #2 ![alt text](https://images.squarespace-cdn.com/content/v1/5894c269e4fcb5e65a1ed623/1581004627030-4CIFC09PV2SJGUGKG0CE/Picture3.png?format=1000w)
			- scenerio two: The device firmware is encrypted in the original release. The vendor decided to change the encryption scheme and release an unencrypted transition version v1.2 which contains the new decryption routine.
				- Similar to scenario 1, we can obtain the decryption routine from v1.2 image and apply it to the latest encrypted firmware. Reading the release notes of the firmware releases could be helpful in identifying the unencrypted transition version. The release notes will usually direct the user to upgrade to an intermediate version before upgrading to the latest version. The intermediate version is very likely to be the unencrypted transition firmware.

			- #3 ![alt text](https://images.squarespace-cdn.com/content/v1/5894c269e4fcb5e65a1ed623/1581004769514-6X7ZOINAWV2BCZC8K1RY/Picture4.png?format=1000w)
			- The device firmware is encrypted in the original release. However, the vendor decided to change the encryption scheme, and release an unencrypted transition version which contains the new decryption routine.
				- In this case, there is no easy method to obtain the decryption routine. One route is to purchase a device and extract the unencrypted firmware from the hardware directly. Another possible route is to perform more analysis on the firmware in hopes to “break the encryption.”


---
### building your toolkit:
- ##### binwalk (we all saw this coming)
	- https://github.com/ReFirmLabs/binwalk

- ##### firmwalker for searching the extracted firmware file system for goodies
	- https://github.com/craigz28/firmwalker

- ##### Firmware Analysis Toolkit (FAT)
	- description: FAT is a toolkit built in order to help security researchers analyze and identify vulnerabilities in IoT and embedded device firmware.
	

- ##### firmware-mod-kit (FMK)
	- The Firmware Mod Kit allows for easy deconstruction and reconstruction of firmware images for various embedded devices.

 - ##### routersploit
	 - https://github.com/threat9/routersploit
	 - this is for dynamic analysis

- ##### attifyOS
	- https://github.com/adi0x90/attifyos
	- AttifyOS is a distro intended to help you perform security assessment and penetration testing of Internet of Things (IoT) devices. It saves you a lot of time by providing a pre-configured environment with all the necessary tools loaded. The new version is based on Ubuntu 18.04 64-Bit

- ##### A damn good dissassembly viewer & decompiler explorer 
	- my suggestions:
		- dissassembly viewers & decompiler explorers:
			- Ghidra & Binary-Ninja
				- https://github.com/NationalSecurityAgency/ghidra
				- https://binary.ninja/demo/

- ##### .ofp & .ops decryptor:
	- this one is kinda misc but im throwing it in because I think its good to have in your toolbox
	- https://github.com/bkerler/oppo_decrypt

- ##### kdiff3
	- Utility for comparing and merging files and directories
	- https://github.com/KDE/kdiff3 or https://invent.kde.org/sdk/kdiff3
---

### OWASP top 10 IoT issues

- 1. weak or hardcoded passwords
- 2. insecure network services
- 3. insecure ecosystem interfaces (web, mobile, backend API or cloud interfaces)
- 4. lack of secure update mechanism
- 5. use of insecure or outdated components
- 6. insufficient privacy protection
- 7. insecure data transfer and storage
- 8. lack of device management
- 9. insecure default settings
- 10. lack of physical hardening


